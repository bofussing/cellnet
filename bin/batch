#!/bin/bash
# NOTE this is designed to run in the repo root
# it saves the current state of the repo and submits the job

STARTTIME="$(date +%y%m%d-%H%M%S)"
INPUT="$1"

NAME="$(basename "$INPUT" .py)"
INDIR="$(dirname "$INPUT")"; if [ "$INDIR" =  "" ]; then INDIR="."; fi
OUTDIR="./results/$INDIR/$NAME/$STARTTIME-RUNNING"

echo -e "  ===  PREPARING BATCHJOB $INPUT at $STARTTIME ===  \n"

mkdir -p "$OUTDIR"
# if cOMMENT is not empty, save it to the COMMENT file

rsync -a "." "$OUTDIR" --exclude .git --exclude results --filter=':- .gitignore'

INPUT="$OUTDIR/$NAME.py"
mv "$OUTDIR/$INDIR/$NAME.py" "$INPUT" 

sbatch bin/ipynb "$NAME" "$INDIR" "$INPUT" "$OUTDIR"
